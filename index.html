<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MCT — Analizador de Nocturnidad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary: #1e3a8a;
      --accent: #2563eb;
      --danger: #dc2626;
      --muted: #64748b;
      --border: #cbd5e1;
    }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; color: #0f172a; }
    h1 { color: var(--primary); margin-bottom: 8px; }
    .subtitle { color: var(--muted); margin-bottom: 16px; }
    .wrap { max-width: 880px; margin: 0 auto; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin: 12px 0 8px; }
    .btn {
      padding: 8px 12px; background: var(--accent); color: #fff; border: none;
      border-radius: 6px; cursor: pointer; font-weight: 600;
    }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    #dropZone {
      border: 2px dashed var(--border); border-radius: 8px; padding: 20px; text-align: center;
      color: var(--muted); margin-top: 10px;
    }
    #dropZone.drag { border-color: var(--accent); color: var(--accent); background: #eff6ff; }
    #progress { height: 8px; background: #e2e8f0; border-radius: 8px; margin-top: 10px; overflow: hidden; }
    #progressBar { height: 100%; width: 0%; background: var(--accent); transition: width 0.2s ease; }
    #progressText { font-size: 12px; color: var(--muted); margin-top: 4px; min-height: 1em; }
    #log { margin-top: 8px; font-size: 13px; color: var(--muted); }
    #results h3 { margin: 16px 0 4px; }
    footer { margin-top: 24px; color: var(--muted); font-size: 12px; text-align: center; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>MCT — Analizador de Nocturnidad</h1>
      <div class="subtitle">Herramienta sencilla para calcular nocturnidad en PDFs con texto.</div>
      <div class="instructions">
        <strong>Instrucciones:</strong><br>
        • Selecciona o arrastra uno o varios archivos PDF.<br>
        • Pulsa <strong>Procesar archivos</strong>.<br>
        • El sistema extraerá los horarios y calculará automáticamente los minutos nocturnos.<br>
        • Puedes descargar los resultados en CSV o en PDF final.<br>
        • Importante: esta herramienta funciona solo con PDFs que contienen texto (no imágenes escaneadas).
      </div>
    </header>

    <div class="controls">
      <input type="file" id="fileInput" accept="application/pdf" multiple>
      <button class="btn" id="processBtn">Procesar archivos</button>
      <button class="btn" id="downloadCsvBtn" disabled>Descargar CSV</button>
      <button class="btn" id="downloadPdfBtn" disabled>Descargar PDF Final</button>
      <button class="btn" id="clearBtn" style="background: var(--danger)">Limpiar</button>
    </div>

    <div id="dropZone">Arrastra tus PDFs aquí</div>

    <div id="progress"><div id="progressBar"></div></div>
    <div id="progressText"></div>

    <div id="log">Esperando archivos...</div>
    <div id="results"></div>

    <footer>© MCT — Herramienta de análisis horario</footer>
  </div>

  <!-- PDF.js (versión estable recomendada) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    // Configuración correcta del worker de PDF.js (CDN)
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

    const fileInput = document.getElementById("fileInput");
    const processBtn = document.getElementById("processBtn");
    const resultsDiv = document.getElementById("results");
    const clearBtn = document.getElementById("clearBtn");
    const dropZone = document.getElementById("dropZone");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const logDiv = document.getElementById("log");
    const downloadCsvBtn = document.getElementById("downloadCsvBtn");
    const downloadPdfBtn = document.getElementById("downloadPdfBtn");

    let archivos = [];
    let resultados = [];

    function log(msg, type = "info") {
      const color = type === "error" ? "#dc2626" : type === "warn" ? "#ca8a04" : "#64748b";
      logDiv.innerHTML = `<span style="color:${color}">${msg}</span>`;
    }

    function setProgress(pct, text = "") {
      progressBar.style.width = `${Math.max(0, Math.min(100, pct))}%`;
      progressText.textContent = text;
    }

    function resetUI() {
      resultados = [];
      resultsDiv.innerHTML = "";
      setProgress(0, "");
      log("Esperando archivos...");
      downloadCsvBtn.disabled = true;
      downloadPdfBtn.disabled = true;
    }

    // Arrastrar/soltar
    ["dragenter", "dragover"].forEach(evt =>
      dropZone.addEventListener(evt, e => {
        e.preventDefault(); e.stopPropagation();
        dropZone.classList.add("drag");
      })
    );
    ["dragleave", "drop"].forEach(evt =>
      dropZone.addEventListener(evt, e => {
        e.preventDefault(); e.stopPropagation();
        dropZone.classList.remove("drag");
      })
    );
    dropZone.addEventListener("drop", e => {
      const items = Array.from(e.dataTransfer.files || []).filter(f => f.type === "application/pdf");
      archivos = items;
      fileInput.files = e.dataTransfer.files; // refleja en el input
      log(`${archivos.length} PDF(s) preparado(s).`);
      setProgress(0, "");
    });

    // Selección manual
    fileInput.addEventListener("change", () => {
      archivos = Array.from(fileInput.files || []).filter(f => f.type === "application/pdf");
      log(`${archivos.length} PDF(s) seleccionado(s).`);
      setProgress(0, "");
    });

    // Procesar
    processBtn.addEventListener("click", async () => {
      resetUI();
      if (!archivos.length) {
        log("No se ha seleccionado ningún PDF.", "warn");
        return;
      }

      setProgress(1, "Inicializando...");
      try {
        const total = archivos.length;
        for (let idx = 0; idx < total; idx++) {
          const file = archivos[idx];
          const pct = Math.round(((idx) / total) * 100);
          setProgress(pct, `Procesando ${file.name} (${idx + 1}/${total})`);

          const { textoCompleto, paginas } = await extraerTextoPDF(file);

          // Cálculo de nocturnidad (ejemplo básico; ajusta a tus reglas reales)
          const minutosNocturnos = calcularNocturnidad(textoCompleto);

          resultados.push({
            nombre: file.name,
            paginas,
            minutos: minutosNocturnos
          });

          resultsDiv.innerHTML += `
            <h3>${file.name}</h3>
            <p><strong>Páginas:</strong> ${paginas}</p>
            <p><strong>Minutos nocturnos detectados:</strong> ${minutosNocturnos}</p>
          `;
        }

        setProgress(100, "Completado.");
        log("Procesamiento finalizado.");
        downloadCsvBtn.disabled = resultados.length === 0;
        downloadPdfBtn.disabled = resultados.length === 0;

      } catch (err) {
        console.error(err);
        log(`Error al procesar: ${err.message || err}`, "error");
        setProgress(0, "");
      }
    });

    // Extraer texto con PDF.js
    async function extraerTextoPDF(file) {
      // Lectura local segura (no hay CORS, al ser File)
      const arrayBuffer = await file.arrayBuffer();
      // Inicializa el documento
      const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;
      let textoCompleto = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const textoPagina = textContent.items.map(item => item.str).join(" ");
        textoCompleto += textoPagina + "\n";
      }
      return { textoCompleto, paginas: pdf.numPages };
    }

    // Cálculo simple de nocturnidad: cuenta ocurrencias de tiempos HH:MM y estima minutos
    function calcularNocturnidad(texto) {
      const regexHora = /\b([01]?\d|2[0-3]):[0-5]\d\b/g;
      const horas = texto.match(regexHora) || [];
      // Nota: Este es un placeholder. Para un cálculo exacto 22:00–06:00, habría que parsear rangos de turnos.
      return horas.length * 60;
    }

    // Limpiar
    clearBtn.addEventListener("click", resetUI);

    // Exportar CSV
    downloadCsvBtn.addEventListener("click", () => {
      let csv = "Archivo,Páginas,Minutos Nocturnos\n";
      resultados.forEach(r => { csv += `${r.nombre},${r.paginas},${r.minutos}\n`; });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "resultados_nocturnidad.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    // Exportar “PDF” (texto plano dentro de un contenedor PDF no es real PDF; se usa .txt para evitar confusión)
    downloadPdfBtn.addEventListener("click", () => {
      const contenido = resultados
        .map(r => `${r.nombre} — Páginas: ${r.paginas} — Minutos nocturnos: ${r.minutos}`)
        .join("\n");
      const blob = new Blob([contenido], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "resultados_nocturnidad.txt";
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
