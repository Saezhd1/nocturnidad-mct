<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MCT ‚Äî Analizador de Nocturnidad</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #1e3a8a; }
    #results { margin-top: 20px; }
    .btn { margin: 5px; padding: 8px 12px; background: #2563eb; color: white; border: none; cursor: pointer; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>MCT ‚Äî Analizador de Nocturnidad</h1>
  <p>Sube uno o varios PDFs con texto (no escaneados).</p>

  <input type="file" id="fileInput" multiple accept="application/pdf">
  <button class="btn" id="processBtn">Procesar archivos</button>
  <button class="btn" id="downloadCsvBtn" disabled>Descargar CSV</button>

  <div id="results"></div>

  <!-- PDF.js desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

    const fileInput = document.getElementById("fileInput");
    const processBtn = document.getElementById("processBtn");
    const resultsDiv = document.getElementById("results");
    const downloadCsvBtn = document.getElementById("downloadCsvBtn");

    let resultados = [];

    processBtn.addEventListener("click", async () => {
      resultados = [];
      resultsDiv.innerHTML = "";
      const files = fileInput.files;
      if (!files.length) {
        resultsDiv.innerHTML = "<p style='color:red'>No se seleccion√≥ ning√∫n PDF.</p>";
        return;
      }

      for (const file of files) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        let textoCompleto = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          // üîß Unir sin espacios para reconstruir horas correctamente
          textoCompleto += textContent.items.map(item => item.str).join("") + "\n";
        }

        // Detectar pares de horas en cada l√≠nea
        const regexTurno = /(\d{2}:\d{2})\s+(\d{2}:\d{2})/g;
        let match;
        let minutosTotales = 0;
        while ((match = regexTurno.exec(textoCompleto)) !== null) {
          const inicio = match[1];
          const fin = match[2];
          minutosTotales += calcularMinutosNocturnos(inicio, fin);
        }

        // Calcular importe (ejemplo: 1,50 ‚Ç¨/hora nocturna)
        const importePorMinuto = 1.50 / 60;
        const importe = (minutosTotales * importePorMinuto).toFixed(2);

        resultados.push({ nombre: file.name, minutos: minutosTotales, importe });

        resultsDiv.innerHTML += `<h3>${file.name}</h3>
          <p>Minutos nocturnos: <strong>${minutosTotales}</strong></p>
          <p>Importe: <strong>${importe} ‚Ç¨</strong></p>`;
      }

      downloadCsvBtn.disabled = false;
    });

    // Funci√≥n para calcular minutos nocturnos reales
    function calcularMinutosNocturnos(inicio, fin) {
      const [h1, m1] = inicio.split(":").map(Number);
      const [h2, m2] = fin.split(":").map(Number);

      let start = h1 * 60 + m1;
      let end = h2 * 60 + m2;
      if (end < start) end += 24 * 60; // cruza medianoche

      const franjas = [
        [22*60, 24*60],   // 22:00‚Äì00:00
        [0, 60],          // 00:00‚Äì00:59
        [4*60, 6*60]      // 04:00‚Äì06:00
      ];

      let minutos = 0;
      for (const [fStart, fEnd] of franjas) {
        const interStart = Math.max(start, fStart);
        const interEnd = Math.min(end, fEnd);
        if (interEnd > interStart) {
          minutos += interEnd - interStart;
        }
      }
      return minutos;
    }

    // Exportar CSV
    downloadCsvBtn.addEventListener("click", () => {
      let csv = "Archivo,Minutos Nocturnos,Importe (‚Ç¨)\n";
      resultados.forEach(r => {
        csv += `${r.nombre},${r.minutos},${r.importe}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "resultados_nocturnidad.csv";
      a.click();
    });
  </script>
</body>
</html>
